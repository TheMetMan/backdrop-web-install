#!/bin/bash
#
# Script to overwrite items from system.core.json file with ignored settings
# then Sync the database you choose, then
# Import Backdrop Settings using Drush 8
#
./backupEssestials SITEFOLDER
echo "Importing the Settings from config/staging"
echo
echo "Removing Unnecessary Settings"
php config/ignoreSettings.php
echo
echo
# Get the database name, user and pwd from settings file
line=`cat web/settings.php | grep mysql`
IFS='\/\/' read -ra first_array <<< "$line"
dbname=${first_array[3]::-2}
IFS='\@' read -ra second_array <<< "${first_array[2]}"
IFS=':' read -ra namepw_array <<< "${second_array[0]}"
uname=${namepw_array[0]}
upwd=${namepw_array[1]}
#echo "dbname = $dbname uname = $uname upwd = $upwd"
# now use them
options=("Local Database" "Dev Database" "Prod Database" "No Database")
echo "Select which Database to import"
select opt in "${options[@]}"
do
    case $opt in
        "Local Database")
            echo "Importing the Local Db"
            gunzip config/local_db/database.sql.gz
            mysql -u $uname -p$upwd $dbname < config/local_db/database.sql
            gzip config/local_db/database.sql
            break
            ;;

        "Dev Database")
	    echo "Importing the Dev Db"
	    gunzip config/dev_db/database.sql.gz
	    mysql -u $uname -p$upwd $dbname < config/dev_db/database.sql
	    gzip config/dev_db/database.sql
            break
            ;;
        "Prod Database")
	    echo "Importing the Prod Db"
	    gunzip config/prod_db/database.sql.gz
	    mysql -u $uname -p$upwd $dbname < config/prod_db/database.sql
	    gzip config/prod_db/database.sql
            break
            ;;
        "No Database")
            echo "No Db"
            break
            ;;
    esac
done
cd web
drush updb
drush cc all
drush bcim
echo
drush updb
drush cc all
git stash
echo "Finished - Ready to test the updates"
echo


